# 路由

## IP选路

![](images/201210212118595088.jpg)

1. 搜索路由表的优先级
```
    主机地址
    网络地址  (IP地址 = 网络地址 + 主机地址)
    默认路由  (默认路由（Default route）:如果IP数据包中的目的地址找不到存在的其它路由时，路由器会默认的选择的路由。)
```
2. 路由表
3. 如果找不到匹配的路由，则返回“主机不可达差错”或“网络不可达差错”

一个典型的路由表如下：

```sh
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.0.0      0.0.0.0         255.255.192.0   U     0      0        0 eth0
0.0.0.0         192.168.0.1      0.0.0.0         UG    100    0        0 eth0
```
输出项的说明：
- Destination  目标网段或者主机
- Gateway      网关地址，”*” 和“0.0.0.0 ”表示目标是本主机所属的网络，不需要路由
- Genmask      网络掩码
- Flags        标记

Flags各项的含义：

- U    该路由可用
- G    该路由是一个网关，如果没有该标志，则是直接路由
- H    该路由是一个主机，如果没有该标志，则是一个网络
- D    该路由是由重定向报文创建的
- M    该路由被ICMP重定向报文修改过

## 路由的修改

可以通过route命令来修改路由表，ICMP重定向报文也会修改路由表

一般在系统的配置文件中会设置默认路由.

## ICMP重定向差错

当IP数据报应该被发送到另一个路由器时，收到数据报的路由器就要给发送端回复一个ICMP重定向差错报文。

重定向一般用来让具有很少选路信息的主机逐渐建立更完善的路由表。

## ICMP路由器发现报文

一般来说，主机在引导以后要广播或多播一份路由器请求报文，一台或多台路由器响应一份路由器通告报文。路由器也会定期地广播或多播路由器通告报文。

## 静态路由，默认路由和默认网关的区别
- 静态路由和动态路由的区别：静态路由一般是由管理员手工设置的路由，而动态路由则是路由器中的动态路由协议根据网络拓扑情况和特定的要求自动生成的路由条目
- 默认路由：又叫缺省路由，默认路由是一种特殊的静态路由，指的是当路由表中与包的目的地址之间没有匹配的表项时路由器能够做出的选择。（默认情况下在路由表中直连路由优先级最高，静态路由优先级其次，下来为动态路由，默认路由最低！）如果没有默认路由，那么目的地址在路由表中没有匹配表项的包将被丢弃。
- 默认网关：我们PC机上配的默认网关就是默认路由

## linux默认网关的设置
两块网卡的情况：
- 一个网关的情况： 一个网卡设一个ip,其中一个网卡不设置gateway就ok.这样上网的时候走带网关的那边,这台机器还能和不带网关的那个网络通讯.这种情况在利用linux当路由器或者代理网关的时候比较常见.因为linux会自动帮你设置路由!它会把你设置的网关设置成默认路由.这时候如果你设置两个网关.linux帮你随机选的默认路由可能是不能上网的那个或者说不是你想要的那个。
- 两个网关的情况： 这种情况相对复杂,复杂到两块网卡都不设置默认网关:)这种情况发生在,这台linux连接的两个网段都不是一个网段!就是通过连接的两个网段还可以访问其它的不同的网段.这种情况下,无论把gateway设到哪边,都会影响到另一个网段所连接的网段不能正常使用.这就是我今天最想表述的问题.在这种情况,如果你想连接多个网段,首先要在正确的网卡上设置正确的ip,剩下的工作就交给route来做了.利用route命令把能上网或者想通过那边上网的网关设置成默认网关,这样就解决了一个网段了.另一个段和它所连接的所有网段,就要一条一个的加路由了.示例
    默认网关:
      route add default gw 224.224.224.224 eth0
    加路由:
      route add -net 192.168.115.0/24 gw 192.168.1.254 eth1
    可能不大理解加路由为啥去115段的连接,要走1.254.这是因为加路由的时候,指定下一跳,只指定和本机连接的那个网关


## 路由协议

路由协议用来从多条路由路径中选择一条最佳的路径，并沿着这条路径将数据流产送到目的设备。

- 路由信息协议（RIP）：采用距离向量算法，收集所有可到达目的地的不同路径，并且保存有关到达每个目的地的最少站点数的路径信息，；同时路由器也把这些信息用RIP协议通知相邻路由器。RIP只适用于小型网络（最大15跳）。
- 开放式最短路径协议（OSPF）：基于链路状态，每个路由器向其同一管理域的所有其它路由器发送链路状态广播信息，并将自制域划分为区，并根据区的位置执行区内路由选择和区间路由选择。
- IS-IS：链路状态路由协议，和OSPF相同，IS-IS也使用了“区域”的概念，同样也维护着一份链路状态数据库，通过最短生成树算法（SPF）计算出最佳路径。
- 边界网关协议（BGP）：外部网关协议，用于与其它自治域的BGP交换网络可达信息（通过TCP确保可靠性）。

## STP和Trill

为了提高网络的可靠性，交换网络通常会使用冗余链路，这会带来环路的风险。而STP和Trill就是为了解决环路问题而生的。

STP（Spanning Tree Protocol）的基本原理是在交换机之间传输BPDU（Bridge Protocol Data Unit）报文，并使用生成树来确定网络拓扑：

- 生成树初始化，建立根网桥
- 根端口选举，选择的依据是端口到根网桥的路径开销最小，如果路径开销相同则使用端口ID最小的端口
- 网段指定端口选举，选择的依据也是到根网桥路径开销最小
- 网络收敛后，只有指定端口和根端口可以转发数据。其他端口为预备端口，被阻塞，不能转发数据

STP最大的问题是二层链路利用率不足，且收敛慢，不适合大型数据中心。IETF又提出了Trill技术来克服STP的种种缺陷。Trill（TRansparent Interconnection of Lots of Links）的核心思想是将成熟的三层路由的控制算法引入到二层交换中，将原先的L2报文加一个新的封装(隧道封装)，转换到新的地址空间上进行转发。而新的地址有与IP类似的路由属性，具备大规模组网、最短路径转发、等价多路径、快速收敛、易扩展等诸多优势，从而规避STP/MSTP等技术的缺陷，实现健壮的大规模二层组网。支持TRILL技术的以太网交换机被称为`RBridge`。

# MPLS

MPLS（Multi-Protocol Label Switching）利用标签进行数据转发，而不是向传统路由决策那样每次数据包进行解包，大大减少了路由决策的时间。当分组进入MPLS网络时，为其分配固定长度的短标记，并将标记与分组封装在一起，在整个转发过程中，交换节点仅根据标记进行转发。
